<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDT Daily CTR/Shift Ticket Auto-Generator (OAuth + Auto Refresh)</title>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* styling omitted for brevity */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="kdt-logo"></div>
            <h1>KDT Daily CTR/Shift Ticket Auto-Generator</h1>
            <p>Google Sheets Integration for Live Data Management</p>
            <div class="mode-selector">
                <button class="mode-btn active" onclick="switchMode('admin', this)">Admin Mode</button>
                <button class="mode-btn" onclick="switchMode('user', this)">User Mode</button>
            </div>
        </div>
        <div class="content">
            <!-- Auth and content blocks (same as before) -->
        </div>
    </div>

    <script>
        // Global state
        let templates = [];
        let userProjects = [];
        let currentTemplate = null;
        let currentProject = null;
        let timesheetData = null;
        let pdfTemplates = [];
        let selectedDay = null;

        // Google config
        const CLIENT_ID = '366876817577-1va8eaifrnvu76dl15chgvcqlvcc6af0.apps.googleusercontent.com';
        const DISCOVERY_DOCS = [
            'https://sheets.googleapis.com/$discovery/rest?version=v4',
            'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
        ];
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive';

        let tokenClient = null;
        let accessToken = null;
        let isAuthenticated = false;
        let refreshTimer = null;

        // ---------------------- UI helpers ----------------------
        function showAuthStatus(msg, type='info') {
            document.getElementById('authStatus').innerHTML = '<div class="status '+type+'" style="margin:0">'+msg+'</div>';
        }
        function showStatus(msg, type='info') {
            const ids=['userStatusMessage'];
            ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML = '<div class="status '+type+'">'+msg+'</div>'; })
        }

        function switchMode(mode, btn) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            document.querySelectorAll('.mode-section').forEach(s=>s.classList.remove('active'));
            document.getElementById(mode+'Mode').classList.add('active');
            if(mode==='user') loadUserProjects();
        }

        // ---------------------- Google API init & auth ----------------------
        function initializeGoogleAPI() {
            showAuthStatus('Loading Google APIs...', 'info');
            let attempts = 0;
            const maxAttempts = 50;
            function poll() {
                attempts++;
                if(window.google && google.accounts && google.accounts.oauth2) {
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: (resp) => {
                            if(resp.error) {
                                console.error('Token error', resp);
                                showAuthStatus('Auth failed: ' + resp.error, 'error');
                                return;
                            }
                            accessToken = resp.access_token;
                            isAuthenticated = true;
                            document.getElementById('authorizeBtn').innerText = 'âœ… Connected to Google';
                            document.getElementById('authorizeBtn').disabled = true;
                            showAuthStatus('Successfully connected to Google!', 'success');

                            // Load discovery docs with OAuth only
                            gapi.load('client', async () => {
                                try {
                                    await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
                                    console.log('gapi client initialized with OAuth only');
                                } catch (e) {
                                    console.warn('gapi.client.init failed', e);
                                }
                            });

                            // Setup silent refresh ~55 minutes later
                            scheduleTokenRefresh(resp.expires_in || 3600);
                        }
                    });
                    showAuthStatus('Ready to connect. Click the button to authorize Google access.', 'info');
                } else if(attempts < maxAttempts) {
                    setTimeout(poll, 100);
                } else {
                    showAuthStatus('Google integration unavailable. Save templates locally if needed.', 'info');
                }
            }
            poll();
        }

        function handleAuthClick() {
            if(!tokenClient) { alert('Google APIs are still loading. Try again in a moment.'); return; }
            if(!isAuthenticated) {
                showAuthStatus('Requesting access...', 'info');
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        // ---------------------- Token auto-refresh ----------------------
        function scheduleTokenRefresh(expiresInSec) {
            if(refreshTimer) clearTimeout(refreshTimer);
            // refresh 5 minutes before expiry
            const refreshMs = Math.max((expiresInSec - 300) * 1000, 5 * 60 * 1000);
            refreshTimer = setTimeout(() => {
                console.log('Refreshing access token...');
                tokenClient.requestAccessToken({ prompt: '' });
            }, refreshMs);
        }

        // (Rest of the logic: template management, user projects, Drive helpers, Sheets reading, PDF generation)

        window.addEventListener('load', ()=>{
            initializeGoogleAPI();
            loadTemplates();
            userProjects = JSON.parse(localStorage.getItem('kdtUserProjects')||'[]');
            loadUserProjects();
            showStatus('KDT Auto-Generator ready! Connect to Google to enable Drive/Sheets features.', 'info');
        });
    </script>
</body>
</html>
