<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDT Daily CTR/Shift Ticket Auto-Generator</title>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2d4a3e 0%, #1a2e23 25%, #374a42 50%, #2d4a3e 75%, #1a2e23 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(248, 249, 250, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 2px solid #5a6c57;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4a5d4a 0%, #3d503d 25%, #556b55 50%, #4a5d4a 75%, #3d503d 100%);
            color: #f0f0f0;
            padding: 30px;
            text-align: center;
            border-bottom: 3px solid #2d4a3e;
        }
        
        .kdt-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            display: block;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23556b55" rx="10"/><text x="50" y="55" text-anchor="middle" font-family="Arial" font-size="24" font-weight="bold" fill="%23f0f0f0">KDT</text></svg>') no-repeat center;
            background-size: contain;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.5));
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            color: #f0f0f0;
        }
        
        .mode-selector {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 12px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .mode-btn {
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .mode-btn.active {
            background: rgba(255, 255, 255, 0.9);
            color: #2d4a3e;
            border-color: white;
        }
        
        .content {
            padding: 40px;
            background: #f8f9fa;
        }
        
        .step {
            margin-bottom: 40px;
            padding: 30px;
            background: #ffffff;
            border-radius: 12px;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .step:hover {
            border-color: #5a6c57;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(90, 108, 87, 0.2);
        }
        
        .step-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2d4a3e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-number {
            background: linear-gradient(135deg, #5a6c57, #4a5d4a);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            border: 2px solid #3d503d;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .project-panel {
            background: #f8f9fa;
            border: 2px solid #5a6c57;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .project-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .project-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .project-card:hover {
            border-color: #5a6c57;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .active-project-card {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border: 2px solid #5a6c57;
        }
        
        input, select, button, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus, button:focus, textarea:focus {
            outline: none;
            border-color: #5a6c57;
            box-shadow: 0 0 0 3px rgba(90, 108, 87, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, #5a6c57, #4a5d4a);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(90, 108, 87, 0.3);
            background: linear-gradient(135deg, #6c7f6c, #5a6c57);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #6c757d;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #20c9c9);
        }
        
        .status {
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            font-weight: 600;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .status.info {
            background: #e2f1e8;
            color: #2d4a3e;
            border: 2px solid #5a6c57;
        }
        
        .file-input {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }
        
        .file-input input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: block;
            padding: 20px;
            border: 2px dashed #6c757d;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
            color: #495057;
        }
        
        .file-input:hover .file-input-label,
        .file-input.has-file .file-input-label {
            border-color: #5a6c57;
            background: #f8f9fa;
            color: #2d4a3e;
        }
        
        .mode-section {
            display: none;
        }
        
        .mode-section.active {
            display: block;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #5a6c57;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .mode-selector {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="kdt-logo"></div>
            <h1>KDT Daily CTR/Shift Ticket Auto-Generator v5.0</h1>
            <p>Google Sheets Integration for Live Data Management</p>
            
            <div class="mode-selector">
                <button class="mode-btn active" onclick="switchMode('admin', this)">Admin Mode</button>
                <button class="mode-btn" onclick="switchMode('user', this)">User Mode</button>
            </div>
        </div>
        
        <div class="content">
            <!-- Google Drive Authentication -->
            <div class="step">
                <div class="step-title">
                    <div class="step-number">🔑</div>
                    Google Drive & Sheets Authentication
                </div>
                <p style="margin-bottom: 20px; color: #718096;">Connect to Google to manage templates and generate PDFs from live spreadsheet data.</p>
                
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center;">
                    <div id="authStatus">
                        <div style="color: #718096;">Not connected to Google</div>
                    </div>
                    <button id="authorizeBtn" onclick="handleAuthClick()" style="width: auto; padding: 15px 25px;">
                        🔗 Connect Google Account
                    </button>
                </div>
            </div>
            
            <!-- Admin Mode -->
            <div id="adminMode" class="mode-section active">
                <!-- Template Management -->
                <div class="step">
                    <div class="step-title">
                        <div class="step-number">📁</div>
                        Template Management
                    </div>
                    
                    <div class="project-panel">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Project Templates</h3>
                            <button onclick="createNewTemplate()" style="width: auto; padding: 10px 20px;">
                                Create New Template
                            </button>
                        </div>
                        
                        <div id="templateList" class="project-list">
                            <!-- Templates will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Template Setup -->
                <div class="step" id="templateSetupStep" style="display: none;">
                    <div class="step-title">
                        <div class="step-number">⚙️</div>
                        Template Setup: <span id="currentTemplateName">New Template</span>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Template Name:</label>
                        <input type="text" id="templateNameInput" placeholder="Enter template name (e.g., 2024 Fire Season)">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Timesheet Template (Excel):</label>
                        <div class="file-input" id="timesheetInput">
                            <input type="file" id="timesheetFile" accept=".xlsx,.xls" onchange="handleTimesheetTemplateUpload(event)" />
                            <label for="timesheetFile" class="file-input-label">
                                <div style="font-size: 2rem; margin-bottom: 10px;">📊</div>
                                <div><strong>Upload BLANK Timesheet Template</strong></div>
                                <div style="color: #a0aec0; margin-top: 5px;">Excel format with headers and structure only</div>
                            </label>
                        </div>
                    </div>
                    
                    <div id="timesheetPreview"></div>
                </div>
                
                <!-- PDF Template Upload -->
                <div class="step" id="pdfTemplateStep" style="display: none;">
                    <div class="step-title">
                        <div class="step-number">📋</div>
                        Upload PDF Templates
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; margin-bottom: 20px;">
                        <div class="file-input" id="pdfInput">
                            <input type="file" id="pdfFile" accept=".pdf" multiple onchange="handlePDFUpload(event)" />
                            <label for="pdfFile" class="file-input-label">
                                <div style="font-size: 2rem; margin-bottom: 10px;">📋</div>
                                <div><strong>Upload CTR and Shift Ticket PDFs</strong></div>
                                <div style="color: #a0aec0; margin-top: 5px;">Blank fillable PDF forms</div>
                            </label>
                        </div>
                        <button onclick="clearAllForms()" class="btn-danger" style="height: fit-content; width: auto; padding: 15px 20px;">
                            Clear All
                        </button>
                    </div>
                    
                    <div id="pdfFormsPreview"></div>
                    
                    <div style="margin-top: 20px;">
                        <button onclick="saveTemplate()" class="btn-success">
                            Save Template
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- User Mode -->
            <div id="userMode" class="mode-section">
                <!-- Active Projects -->
                <div class="step">
                    <div class="step-title">
                        <div class="step-number">📂</div>
                        My Active Projects
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <button onclick="showNewProjectDialog()" class="btn-success" style="width: auto; padding: 12px 24px;">
                            + Start New Project
                        </button>
                    </div>
                    
                    <div id="activeProjectsList" class="project-list">
                        <!-- Active projects will be shown here -->
                    </div>
                </div>
                
                <!-- New Project Dialog -->
                <div class="step" id="newProjectDialog" style="display: none;">
                    <div class="step-title">
                        <div class="step-number">🆕</div>
                        Start New Project
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px;">Project Name:</label>
                            <input type="text" id="newProjectName" placeholder="e.g., Canyon Fire 2024">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px;">Select Template:</label>
                            <select id="templateSelect">
                                <option value="">Choose a template...</option>
                            </select>
                        </div>
                    </div>
                    
                    <button onclick="createUserProject()" class="btn-success">
                        Create Project & Open Spreadsheet
                    </button>
                </div>
                
                <!-- PDF Generation -->
                <div class="step" id="pdfGenerationStep" style="display: none;">
                    <div class="step-title">
                        <div class="step-number">📝</div>
                        Generate PDFs for: <span id="activeProjectName"></span>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                        <p><strong>Spreadsheet:</strong> <a id="spreadsheetLink" href="#" target="_blank" style="color: #5a6c57;">Open in Google Sheets</a></p>
                        <p style="margin-top: 10px;"><strong>Last Updated:</strong> <span id="lastUpdated">Checking...</span></p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px;">Fire Name:</label>
                            <input type="text" id="fireNameInput" placeholder="Enter fire name">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px;">Your Name:</label>
                            <input type="text" id="userNameInput" placeholder="Enter your name">
                        </div>
                    </div>
                    
                    <button onclick="loadSpreadsheetData()" class="btn-info" style="margin-bottom: 20px;">
                        🔄 Load Current Spreadsheet Data
                    </button>
                    
                    <div id="daySelector" style="margin: 20px 0;">
                        <!-- Day selection will appear here after loading data -->
                    </div>
                    
                    <div id="selectedDayPreview" style="display: none;">
                        <h4>Selected Day Summary</h4>
                        <div id="summaryInfo"></div>
                        <button onclick="generatePDFs()" id="generateBtn" class="btn-success" style="margin-top: 20px;">
                            Generate & Download PDFs
                        </button>
                    </div>
                    
                    <div id="userStatusMessage"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        var templates = [];
        var userProjects = [];
        var currentTemplate = null;
        var currentProject = null;
        var timesheetData = null;
        var pdfTemplates = [];
        var selectedDay = null;
        var isAuthenticated = false;
        var accessToken = null;
        var tokenClient;
        var gapiInited = false;
        var currentMode = 'admin';
        
        // Google API configuration
        const CLIENT_ID = '366876817577-1va8eaifrnvu76dl15chgvcqlvcc6af0.apps.googleusercontent.com';
        const API_KEY = 'YOUR_API_KEY_HERE'; // You'll need to add an API key
        const DISCOVERY_DOCS = [
            'https://sheets.googleapis.com/$discovery/rest?version=v4',
            'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
        ];
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
        
        // Initialize Google API
        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }
        
        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function() {
                gapiInited = true;
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            }, function(error) {
                console.error('Error initializing Google API:', error);
                showAuthStatus('Error initializing Google APIs. Check console for details.', 'error');
            });
        }
        
        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                isAuthenticated = true;
                document.getElementById('authorizeBtn').innerHTML = '✅ Connected to Google';
                document.getElementById('authorizeBtn').disabled = true;
                showAuthStatus('Successfully connected to Google!', 'success');
                loadTemplates();
                loadUserProjects();
            } else {
                isAuthenticated = false;
                document.getElementById('authorizeBtn').innerHTML = '🔗 Connect Google Account';
                document.getElementById('authorizeBtn').disabled = false;
                showAuthStatus('Click to connect your Google account', 'info');
            }
        }
        
        function handleAuthClick() {
            if (gapiInited) {
                gapi.auth2.getAuthInstance().signIn();
            } else {
                alert('Google APIs are still loading. Please try again in a moment.');
            }
        }
        
        function handleSignoutClick() {
            gapi.auth2.getAuthInstance().signOut();
        }
        
        // Mode switching
        function switchMode(mode, button) {
            currentMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            if (button) button.classList.add('active');
            
            document.querySelectorAll('.mode-section').forEach(section => section.classList.remove('active'));
            document.getElementById(mode + 'Mode').classList.add('active');
            
            if (mode === 'user') {
                loadUserProjects();
            }
        }
        
        // Template Management (Admin)
        function createNewTemplate() {
            currentTemplate = {
                name: '',
                created: new Date().toISOString(),
                timesheetTemplate: null,
                pdfTemplates: []
            };
            
            document.getElementById('templateSetupStep').style.display = 'block';
            document.getElementById('currentTemplateName').textContent = 'New Template';
            document.getElementById('templateNameInput').value = '';
        }
        
        function handleTimesheetTemplateUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            showStatus('Processing template...', 'info');
            
            var reader = new FileReader();
            reader.onload = function(e) {
                currentTemplate.timesheetTemplate = {
                    name: file.name,
                    data: e.target.result
                };
                
                document.getElementById('timesheetPreview').innerHTML = 
                    '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">' +
                    '<strong>Template uploaded:</strong> ' + file.name +
                    '</div>';
                
                document.getElementById('pdfTemplateStep').style.display = 'block';
                showStatus('Template uploaded successfully!', 'success');
            };
            reader.readAsArrayBuffer(file);
        }
        
        function handlePDFUpload(event) {
            var files = Array.from(event.target.files);
            if (!files.length) return;
            
            pdfTemplates = [];
            files.forEach(function(file) {
                pdfTemplates.push({
                    name: file.name,
                    file: file,
                    type: file.name.toLowerCase().includes('ctr') ? 'ctr' : 
                          file.name.toLowerCase().includes('shift') ? 'shift' : 'unknown'
                });
            });
            
            displayPDFPreview();
        }
        
        function displayPDFPreview() {
            var preview = document.getElementById('pdfFormsPreview');
            if (pdfTemplates.length === 0) {
                preview.innerHTML = '';
                return;
            }
            
            var html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;"><h4>PDF Templates</h4>';
            pdfTemplates.forEach(function(template) {
                html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 6px; margin-bottom: 10px;">' +
                    '<div><strong>' + template.name + '</strong>' +
                    '<div style="color: #718096; font-size: 0.9rem;">Type: ' + template.type.toUpperCase() + '</div>' +
                    '</div></div>';
            });
            html += '</div>';
            
            preview.innerHTML = html;
        }
        
        function clearAllForms() {
            pdfTemplates = [];
            document.getElementById('pdfFile').value = '';
            displayPDFPreview();
        }
        
        function saveTemplate() {
            var templateName = document.getElementById('templateNameInput').value.trim();
            
            if (!templateName) {
                alert('Please enter a template name.');
                return;
            }
            
            if (!currentTemplate.timesheetTemplate) {
                alert('Please upload a timesheet template.');
                return;
            }
            
            if (pdfTemplates.length === 0) {
                alert('Please upload PDF templates.');
                return;
            }
            
            // Convert PDFs to base64 for storage
            var promises = pdfTemplates.map(function(template) {
                return new Promise(function(resolve) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        resolve({
                            name: template.name,
                            type: template.type,
                            data: btoa(String.fromCharCode.apply(null, new Uint8Array(e.target.result)))
                        });
                    };
                    reader.readAsArrayBuffer(template.file);
                });
            });
            
            Promise.all(promises).then(function(pdfData) {
                currentTemplate.name = templateName;
                currentTemplate.pdfTemplateData = pdfData;
                
                // Save to localStorage
                templates.push(currentTemplate);
                localStorage.setItem('kdtTemplates', JSON.stringify(templates));
                
                loadTemplates();
                alert('Template saved successfully!');
                
                // Reset form
                document.getElementById('templateSetupStep').style.display = 'none';
                document.getElementById('pdfTemplateStep').style.display = 'none';
            });
        }
        
        function loadTemplates() {
            var saved = localStorage.getItem('kdtTemplates');
            templates = saved ? JSON.parse(saved) : [];
            
            var container = document.getElementById('templateList');
            if (templates.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; padding: 40px;">No templates yet. Create your first template!</p>';
                return;
            }
            
            var html = '';
            templates.forEach(function(template, index) {
                html += '<div class="project-card">' +
                    '<h4>' + template.name + '</h4>' +
                    '<p style="color: #718096;">Created: ' + new Date(template.created).toLocaleDateString() + '</p>' +
                    '<button onclick="deleteTemplate(' + index + ')" class="btn-danger" style="width: auto; padding: 8px 15px; font-size: 0.9rem; margin-top: 10px;">Delete</button>' +
                    '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function deleteTemplate(index) {
            if (confirm('Delete this template?')) {
                templates.splice(index, 1);
                localStorage.setItem('kdtTemplates', JSON.stringify(templates));
                loadTemplates();
            }
        }
        
        // User Mode Functions
        function loadUserProjects() {
            var saved = localStorage.getItem('kdtUserProjects');
            userProjects = saved ? JSON.parse(saved) : [];
            
            var container = document.getElementById('activeProjectsList');
            if (userPro
